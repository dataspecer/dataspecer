
test("Aggregate class profile with duplicate IRIs should deduplicate conceptIris.", () => {
  const aggregator = createDefaultProfileEntityAggregator();
  const actual = aggregator.aggregateSemanticModelClassProfile(
    {
      id: "profile-1",
      type: [SEMANTIC_MODEL_CLASS_PROFILE],
      iri: ":profile-1",
      name: { "": "Profile 1" },
      nameFromProfiled: null,
      description: { "": "First profile" },
      descriptionFromProfiled: null,
      profiling: ["class-1", "profile-2"],
      usageNote: { "": "note" },
      usageNoteFromProfiled: null,
      externalDocumentationUrl: null,
      tags: [],
    },
    [
      {
        id: "class-1",
        type: [SEMANTIC_MODEL_CLASS],
        iri: "http://example.com/Dataset",
        name: { "": "Dataset" },
        description: { "": "A dataset" },
        externalDocumentationUrl: null,
      },
      {
        id: "profile-2",
        type: [SEMANTIC_MODEL_CLASS_PROFILE],
        iri: ":profile-2",
        name: null,
        nameFromProfiled: null,
        description: null,
        descriptionFromProfiled: null,
        profiling: ["class-1"],
        usageNote: null,
        usageNoteFromProfiled: null,
        conceptIris: ["http://example.com/Dataset"],
        externalDocumentationUrl: null,
        tags: [],
      } satisfies AggregatedProfiledSemanticModelClass,
    ]
  );

  // Should only contain the IRI once, not twice
  expect(actual.conceptIris).toStrictEqual(["http://example.com/Dataset"]);
});

test("Aggregate relationship profile with duplicate IRIs should deduplicate conceptIris.", () => {
  const aggregator = createDefaultProfileEntityAggregator();
  const actual = aggregator.aggregateSemanticModelRelationshipProfile(
    {
      id: "rel-profile-1",
      type: [SEMANTIC_MODEL_RELATIONSHIP_PROFILE],
      ends: [
        {
          iri: "rel-profile-1-domain",
          name: null,
          nameFromProfiled: null,
          description: null,
          descriptionFromProfiled: null,
          cardinality: null,
          concept: "domain-concept",
          profiling: [],
          usageNote: null,
          usageNoteFromProfiled: null,
          externalDocumentationUrl: null,
          tags: [],
        },
        {
          iri: "rel-profile-1-range",
          name: { "": "title" },
          nameFromProfiled: null,
          description: null,
          descriptionFromProfiled: null,
          cardinality: null,
          concept: "range-concept",
          profiling: ["rel-1", "rel-profile-2"],
          usageNote: null,
          usageNoteFromProfiled: null,
          externalDocumentationUrl: null,
          tags: [],
        },
      ],
    },
    [
      {
        id: "rel-1",
        type: [SEMANTIC_MODEL_RELATIONSHIP],
        ends: [
          {
            iri: "rel-1-domain",
            name: { "": "domain" },
            description: { "": "domain desc" },
            cardinality: undefined,
            concept: "domain-concept",
            externalDocumentationUrl: null,
          },
          {
            iri: "http://example.com/title",
            name: { "": "title" },
            description: { "": "The title" },
            cardinality: undefined,
            concept: "range-concept",
            externalDocumentationUrl: null,
          },
        ],
      },
      {
        id: "rel-profile-2",
        type: [SEMANTIC_MODEL_RELATIONSHIP_PROFILE],
        ends: [
          {
            iri: "rel-profile-2-domain",
            name: null,
            nameFromProfiled: null,
            description: null,
            descriptionFromProfiled: null,
            cardinality: null,
            concept: "domain-concept",
            profiling: [],
            usageNote: null,
            usageNoteFromProfiled: null,
            conceptIris: [],
            externalDocumentationUrl: null,
            tags: [],
          },
          {
            iri: "rel-profile-2-range",
            name: null,
            nameFromProfiled: null,
            description: null,
            descriptionFromProfiled: null,
            cardinality: null,
            concept: "range-concept",
            profiling: ["rel-1"],
            usageNote: null,
            usageNoteFromProfiled: null,
            conceptIris: ["http://example.com/title"],
            externalDocumentationUrl: null,
            tags: [],
          },
        ],
      },
    ]
  );

  // Should only contain the IRI once in the second end, not twice
  expect(actual.ends[1]?.conceptIris).toStrictEqual(["http://example.com/title"]);
});
